# Internationalization (i18n)

**Full implementation TODOs:** [I18N_TODO.md](./I18N_TODO.md)

## Current state

The app supports **English** (default), **Portuguese**, and **Spanish** using [next-intl](https://next-intl.dev/) with the Next.js App Router.

- **Locales:** `en`, `pt`, `es`. Default locale is `en`.
- **URL strategy:** `localePrefix: 'never'` — the same URL is used for all locales (e.g. `/dashboard` for everyone). The active locale is stored in the next-intl cookie and can be detected from `Accept-Language` on first visit.
- **Detection:** Browser `Accept-Language` and next-intl cookie (set when the user switches locale via the locale switcher). Old bookmarks or links to `/pt/...` or `/es/...` are redirected to the same path without the prefix and the locale cookie is set so the user still sees the intended language.



## Where things live

| Item | Location |
|------|----------|
| Routing config | `i18n/routing.ts` |
| Request config (locale + messages) | `i18n/request.ts` |
| Navigation (Link, redirect, useRouter, usePathname) | `i18n/navigation.ts` |
| Message files | `messages/en.json`, `messages/pt.json`, `messages/es.json` |
| Locale layout | `app/[locale]/layout.tsx` |
| Middleware | `middleware.ts` (next-intl composed with auth, rate limit, maintenance) |

All page routes live under `app/[locale]/` so every request has a locale. API routes stay under `app/api/` (no locale segment).

## Using translations

- **Client components:** `import { useTranslations } from "next-intl";` then `const t = useTranslations("namespace");` and `t("key")`.
- **Server components:** `import { getTranslations } from "next-intl/server";` then `const t = await getTranslations("namespace");` and `t("key")`.
- **Links and redirects:** Use `Link`, `redirect`, and `useRouter` from `@/i18n/navigation` so navigation and locale switching work correctly. With `localePrefix: 'never'`, the URL does not change when switching language; the locale is updated via cookie and the page refreshes or re-renders with the new messages.

## Message namespaces

Messages are grouped by namespace in the JSON files, e.g. `common`, `auth`, `errors`, `metadata`, `landing`. Add new keys under the right namespace and reference them as `t("key")` or nested `t("parent.child")` (e.g. `landing.hero.headline`).

## Locale switcher

The **LocaleSwitcher** component (`components/common/locale-switcher.tsx`) is used in the landing header and footer, and the **user avatar menu** has a Language section (EN | PT | ES). **In production, the language selector is hidden**; it is only visible in development so that locale can be tested without exposing the option to end users.

- **Landing:** Use `variant="short"` so only **EN**, **PT**, **ES** are shown (no icon, no full names).
- **User menu:** Language is a section in the avatar dropdown (Feedback, Help, Privacy, Terms, then **Language** with EN | PT | ES); the label uses `common.language` (Language / Idioma). The active locale is visually highlighted.
- **Full variant:** Default `variant="full"` shows the Languages icon and full names (English, Português, Español).

## What is translated so far

- **Landing & auth:** Landing hero, header/footer, metadata, locale switcher; login, signup, forgot/reset password, verify OTP (auth.*, errors.*). Navigation uses `@/i18n/navigation`.
- **Protected app:** Nav, settings sections, user menu, bottom nav, page titles; dashboard, transactions, reports, planning (budgets/goals), accounts, members, subscriptions, debts, planned payments, help & support, feedback. All use namespaced keys (nav.*, dashboard.*, transactions.*, etc.) and EN/PT/ES in message files.
- **Common UI:** Confirm dialog defaults and Delete Account, Account Required, Cancel Subscription dialogs (`dialogs.*`); generic toasts (`toasts.*`); billing/subscription guards (`billing.*`); forms and buttons (`forms.*`, `common.*`). Empty states are mostly covered by page namespaces.
- **Public pages:** Account deleted/blocked, maintenance, subscription success, FAQ (layout), Contact, footer links. ToS/Privacy and Blog/docs are not translated (out of scope).
- **Metadata:** Root layout uses `metadata.title` and `metadata.description`. Main protected pages (dashboard, transactions, accounts, reports, planning, members, subscriptions, debts, planned payments, insights, settings, help-support, feedback, investments) set locale-specific `<title>` via `generateMetadata()` using `metadata.pages.*` and `metadata.titleSuffix`.
- **Full checklist:** See [I18N_TODO.md](./I18N_TODO.md) for item-by-item status and remaining work.

## Remaining work

- **Empty states and chart labels:** Done. Budgets/goals tabs, goals overview, expenses pie chart, accounts composition, budget-vs-actual, daily expenses, budget execution, blog list, categories module, account card, payment history, payment method manager, and verify-login-otp tooltip use translation keys (`planning.*`, `dashboard.*`, `reports.*`, `settings.*`, `accounts`, `billing`, `auth`).
- **Client `apiUrl()`:** Main client flows now use `apiUrl()`: auth (login, forgot-password, user menu, mobile header, more menu), data pages (debts, transactions, subscriptions, planned payments, feedback, help-support), dashboard widgets, household module, budgets tab and planning/budgets page. Run `npm run check:i18n-keys` to ensure en/pt/es keys stay in sync.
- **Missing keys:** In development, missing keys render as `namespace.key`. In production they render as `—` (see `getMessageFallback` in `i18n/request.ts` and `app/[locale]/layout.tsx`).
- **Before release:** Run a smoke test (switch locale EN/PT/ES on landing, auth, dashboard, settings; confirm no missing keys and correct copy). See [I18N_TODO.md](./I18N_TODO.md) §8.

## Locale switch and subscription/plan

When the user switches language via the locale switcher, the next-intl cookie is updated and the app refreshes or re-renders on the same URL. The protected layout runs again and passes fresh `initialData` (subscription, plan) to `SubscriptionProvider`. The provider syncs its state when `initialData` changes so the plan is still recognized after a locale switch.

## Client-side API calls

**Use `apiUrl(path)`** from `@/lib/utils/api-base-url` for client-side API calls so requests always hit the correct origin:

```ts
import { apiUrl } from "@/lib/utils/api-base-url";

const res = await fetch(apiUrl("/api/v2/billing/subscription"));
```

Auth, profile, subscription context, billing, and main data flows (transactions, subscriptions, debts, planned payments, feedback, help-support, dashboard, household, budgets) use `apiUrl` for client-side fetch. Add it to any new client component that calls `fetch("/api/...")`.

## Translations from Supabase

User-facing text stored in Supabase can be translated via locale columns. Migration `20260223100000_add_i18n_translation_columns.sql` adds:

| Table | New columns | Default (EN) column |
|-------|-------------|---------------------|
| `app_plans` | `name_pt`, `name_es` | `name` |
| `external_service_categories` | `name_pt`, `name_es` | `name` |
| `system_error_codes` | `user_message_pt`, `user_message_es` | `user_message` |
| `categories` | `name_pt`, `name_es` | `name` |
| `subcategories` | `name_pt`, `name_es` | `name` |

**Usage:** In repositories or services, for the current locale use the translated column with fallback to the default (e.g. for `locale === 'pt'`: `row.name_pt ?? row.name`). Until pt/es columns are backfilled, they are NULL and the default column is used.

## API and server messages

API routes still return English messages. For a fully localized API, the application layer could throw `AppError` with a message key and the API could resolve it using the request’s `Accept-Language`; that is not implemented yet.

## Key consistency check

Run `npm run check:i18n-keys` to ensure `messages/en.json`, `messages/pt.json`, and `messages/es.json` have the same key structure. Add this to CI to catch drift. When adding new keys, add them to all three files (use EN text in pt/es until translated if needed).

## Build note

With Next.js 16 and `cacheComponents`, some routes may hit “Uncached data was accessed outside of &lt;Suspense&gt;” during static prerender. `unstable_noStore()` is used in several layouts and pages (e.g. admin dashboard, design, protected layout) to opt those routes into dynamic rendering. The app runs correctly in development and in production when those routes are rendered on demand.
